---
name: changelog

on:
  workflow_dispatch:

env:
  BRANCH: main
  COMMITTER_BOT: GitHub <noreply@github.com>
  AUTHOR_BOT: actions-bot <actions-bot@users.noreply.github.com>

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    name: changelog-generator
    # if: "!contains(github.event.head_commit.message, 'skip')"
    steps:
    # To use this repository's private action, you must check out the repository
    - name: checkout
      uses: actions/checkout@v2.3.4
      with:
        fetch-depth: 0

    # https://github.com/marketplace/actions/tag-changelog
    - name: create changelog text
      uses: TriPSs/conventional-changelog-action@v3
      id: ch
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        release-count: 0
        output-file: false
        skip-version-file: true
        skip-commit: true

    - name: read 'templates/changelog'
      id: ch-template
      uses: juliangruber/read-file-action@v1
      with:
        path: .github/templates/changelog

    # - name: read 'changelog.md'
    #   id: ch-updated
    #   uses: juliangruber/read-file-action@v1
    #   with:
    #     path: CHANGELOG.md

    - name: write to changelog.md
      uses: DamianReeves/write-file-action@master
      with:
        path: CHANGELOG.md
        contents: |
          ${{ steps.ch-template.outputs.content }}${{ steps.ch.outputs.changelog }}
        write-mode: overwrite

    - name: read file
      run: |
        echo ${{ steps.ch.outputs.skipped }}
        echo ${{ steps.ch.outputs.tag }}

        cat CHANGELOG.md

    - name: check local changes
      id: diff
      run: |
        changed_files=$(git status --porcelain --untracked-files=all | wc -l)
        echo ::set-output name=count::$changed_files
        echo ::set-output name=created::$(date)
        echo ::set-output name=tag::${{ steps.ch.outputs.tag }}
        echo ::set-output name=skipped::${{ steps.ch.outputs.skipped }}
      shell: bash

    -
      name: create pull request
      uses: peter-evans/create-pull-request@v3.8.2
      if: ${{ steps.ch.outputs.tag }}
      # if: ${{ steps.ch.outputs.skipped == 'true' }}
      # issue: https://github.com/peter-evans/create-pull-request/issues/48
      id: cpr
      with:
        branch: docs/changelog
        # base: ${{ github.head_ref }}
        # delete-branch: true
        # labels: |
        #   kind/docs
        #   :memo: documentation
        #   :memo: docs
        #   :bell: approved
        #   :bell: automerge
        #   :robot: bot
        committer: ${{ env.COMMITTER_BOT }}
        author: ${{ env.AUTHOR_BOT }}
        # title: |
        #   "docs: update changelog "${{ steps.ch.outputs.tag }} #${{ github.run_number }}"'
        # commit-message: |
        #   'docs: Update CHANGELOG.md "${{ github.workflow }} #${{ github.run_number }}" [skip ci]'
        # body: |
        #   ## Description

        #   Update CHANGELOG.md

        #   ${{ steps.ch.outputs.clean_changelog }}

        #   ## Update report workflow

        #   - Updated with *today's* date **`${{ steps.diff.outputs.created }}`**
        #   - Current Tag: **`${{ steps.ch.outputs.tag }}`**
        #   - Name: **${{ github.workflow }}**
        #   - Run ID: **${{ github.run_id }}**
        #   - Run Number: **${{ github.run_number }}**

        #   _Auto-generated by [create-pull-request][1]

        #   [1]: https://github.com/peter-evans/create-pull-request

    - name: check outputs
      if: ${{ steps.ch.outputs.skipped == 'false' }}
      run: |
        echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
        echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
