name: changelog

on:
  push:
    branches:
    - main
    paths-ignore:
    - "README.md"
    - "CHANGELOG.md"
    - "renovate.json"
  pull_request:
    types: [opened, reopened]
    paths-ignore:
    - "README.md"
    - "CHANGELOG.md"
    - "renovate.json"
  workflow_dispatch:
    inputs:
      tags:
        description: 'manual trigger'
  release:
    types: # This configuration does not affect the page_build event above
    - created

env:
  isForkedRepository: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository }}
  BRANCH: main

jobs:
  changelog:
    runs-on: ubuntu-latest
    name: Generate changelog for main branch
    if: "!contains(github.event.head_commit.message, 'skip')"
    steps:
    # To use this repository's private action, you must check out the repository
    - name: Checkout
      uses: actions/checkout@v2.3.4
      with:
        fetch-depth: 30
        submodules: 'true'

    # - name: Generate changelog
    #   id: changelog
    #   uses: charmixer/auto-changelog-action@v1
    #   with:
    #     token: ${{ secrets.GITHUB_TOKEN }}

    # https://github.com/marketplace/actions/tag-changelog
    - name: Create changelog text
      uses: loopwerk/conventional-changelog-action@latest
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        config_file: .github/tag-changelog-config.js

    - name: Read CHANGELOG.md
      id: readfile
      uses: juliangruber/read-file-action@v1
      with:
        path: ./CHANGELOG.md

    - name: Write to CHANGELOG.md
      uses: DamianReeves/write-file-action@master
      with:
        path: ./CHANGELOG.md
        contents: ${{ steps.changelog.outputs.changelog }}${{ steps.readfile.outputs.content }}
        write-mode: overwrite

    - name: push
      uses: github-actions-x/commit@v2.8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        name: ${{ secrets.GITHUB_USER }}
        email: ${{ secrets.GITHUB_EMAIL }}
        push-branch: ${{ env.BRANCH }}
        commit-message: 'chore: Updated CHANGELOG.md [skip ci]'
        force-add: 'true'
        files: CHANGELOG.md
